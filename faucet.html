<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>加入Goosebox！ - Goosebox</title>
    
    <link rel="icon" type="image/x-icon" href="assets/logo_beta.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.3.2/css/flag-icons.min.css" />
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        wood:  { 50:'#f6efe9',100:'#eadfd3',200:'#d8c1a8',300:'#c8a37e',400:'#b8875a',500:'#9b6f48',600:'#7c583a',700:'#654830',800:'#523a26',900:'#3e2c1d'},
                        hay:   { 50:'#fff8e6',100:'#ffefc2',200:'#ffe38f',300:'#ffd24d',400:'#fbbf24',500:'#f59e0b'},
                        field: { 50:'#f4fde8',100:'#e3fac5',200:'#c6f18c',300:'#a2e251',400:'#7ace24',500:'#5cab17'},
                        stone: { 300:'#d1d5db',400:'#9ca3af',700:'#374151'}
                    },
                    boxShadow: { ui:'0 8px 20px rgba(0,0,0,.12)' },
                    borderRadius: { ui:'18px' }
                }
            }
        }
    </script>
    
    <style>
        .grain {
            background:
                radial-gradient(1000px 400px at 80% -20%, rgba(255,255,255,.25), rgba(255,255,255,0)),
                linear-gradient(180deg, #f7e7d5 0%, #fff6e8 40%, #f9efe3 100%);
        }
        .float { animation: float 4s ease-in-out infinite; }
        @keyframes float { 0%{transform:translateY(0)}50%{transform:translateY(-8px)}100%{transform:translateY(0)} }
        .logo { height: 50px; width: auto; }
        
        /* 修复 Reown 字体预加载警告 - 创建一个不可见的元素使用该字体 */
        .reown-font-preload {
            font-family: 'KHTeka-Medium', sans-serif;
            position: absolute;
            visibility: hidden;
            width: 0;
            height: 0;
            overflow: hidden;
        }
    </style>
  <script type="module" crossorigin src="./assets/faucet--rIFf0pO.js"></script>
</head>
<body class="bg-wood-50 text-stone-700">
    <div class="reown-font-preload">.</div>

    <header class="sticky top-0 z-50">
        <div class="bg-wood-400 shadow-ui text-white">
            <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <img alt="Goosebox Logo" class="logo" loading="lazy" src="assets/logo_beta.png"/>
                    <div class="leading-tight">
                        <div class="font-extrabold text-lg">Goosebox</div>
                        <div class="text-white/80 text-xs" id="subtitle" data-lang="faucet.subtitle">Get Faucet</div>
                    </div>
                </div>

                <nav class="hidden md:flex items-center gap-6 text-white/90">                    
                    <!-- 语言选择器 -->
                    <div class="relative group">
                        <button class="flex items-center gap-2 hover:text-white transition-colors duration-200" id="currentLang">
                            <span id="currentLangFlag" class="fi fi-us text-lg"></span>
                            <span id="currentLangName">English</span>
                        </button>
                        <div class="absolute left-1/2 -translate-x-1/2 top-full mt-2 bg-white rounded-ui shadow-ui border border-wood-200 py-2 min-w-[180px] opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 transform origin-top scale-95 group-hover:scale-100">
                            <div id="languageOptions"></div>
                        </div>
                    </div>
                    
                    <button id="open-connect-modal" class="px-4 py-2 rounded-ui bg-hay-400 text-wood-900 font-bold hover:bg-hay-300 transition-colors duration-200" data-lang="nav.wallet">
                    </button>
                    <button id="disconnect" class="px-4 py-2 rounded-ui bg-red-500 text-white font-bold hover:bg-red-600 transition-colors duration-200" style="display: none;" data-lang="nav.disconnect">
                        Disconnect
                    </button>
                </nav>
                
                <div class="md:hidden flex items-center gap-2">
                    <button id="open-connect-modal-mobile" class="px-3 py-2 rounded-ui bg-hay-400 text-wood-900 font-bold text-sm hover:bg-hay-300 transition-colors duration-200" data-lang="nav.wallet">
                    </button>
                    <button id="disconnect-mobile" class="px-3 py-2 rounded-ui bg-red-500 text-white font-bold text-sm hover:bg-red-600 transition-colors duration-200" style="display: none;" data-lang="nav.disconnect">
                        Disconnect
                    </button>
                </div>
            </div>
        </div>
    </header>

    <section class="grain">
        <div class="max-w-6xl mx-auto px-4 py-12 md:py-16">
            <div class="grid md:grid-cols-2 gap-8 items-center">
                <div>
                    <h1 class="text-3xl md:text-4xl font-extrabold text-wood-900 leading-tight" id="heroTitle" data-lang="faucet.heroTitle">Join Goosebox！</h1>
                    <p class="mt-4 text-stone-700 text-lg" id="heroDescription" data-lang="faucet.heroDescription">Claim PHRS daily and experience the Goosebox ecosystem</p>
                    <div class="mt-6 p-4 bg-white/80 rounded-ui border border-wood-200">
                        <div class="text-sm text-stone-600 mb-2" data-lang="faucet.networkInfo.title">Network Info</div>
                        <div class="text-stone-700">
                            <div data-lang="faucet.networkInfo.network"><strong>Network:</strong> Pharos Testnet (Chain ID: 688688)</div>
                            <div data-lang="faucet.networkInfo.dailyLimit"><strong>Daily Limit:</strong> 0.1 PHRS</div>
                            <div data-lang="faucet.networkInfo.cooldown"><strong>Cooldown:</strong> 24 hours</div>
                        </div>
                    </div>
                </div>

                <div class="float">
                    <img src="assets/goosebox_ranch_phrs.png" alt="Goosebox Ranch" class="w-full" loading="lazy">
                </div>
            </div>
        </div>
    </section>

    <section>
        <div class="max-w-6xl mx-auto px-4">
            
            <div class="rounded-ui bg-white border border-wood-200 p-6 shadow-ui mb-6" style="display: none;">
                <h3 class="text-xl font-bold text-wood-900 mb-4" data-lang="faucet.sections.walletConnection">1. Wallet Connection Status</h3>
                <div id="walletStatus" class="text-stone-600" data-lang="faucet.walletStatus.integrated">Wallet integrated, authentication flow will start automatically after connection</div>
            </div>

            <div id="faucetClaimSection" class="rounded-ui bg-gradient-to-br from-white to-hay-50 border border-wood-200 p-8 shadow-ui mb-6">
                <div class="text-center mb-6">
                    <h3 class="text-2xl font-extrabold text-wood-900 mb-2" data-lang="faucet.sections.claimTokens">Claim Testnet Tokens</h3>
                    <p class="text-stone-600" data-lang="faucet.claim.description">Connect wallet, complete verification, and claim with one click!</p>
                </div>
                <div id="faucetStatus" class="mt-4"></div>
                <div class="mb-4 p-4 bg-field-50 border border-field-200 rounded-lg">
                    <div class="text-sm text-stone-600 mb-2" data-lang="faucet.claim.instructions">Claim Instructions</div>
                    <ul class="text-sm text-stone-800 space-y-1">
                        <li data-lang="faucet.security.walletCooldown">• Wallet Cooldown: 24 hours per wallet address</li>
                        <li data-lang="faucet.security.ipLimit">• IP Limit: 24 hours per IP address</li>
                        <li data-lang="faucet.security.twitterLimit">• Twitter Limit: 24 hours per Twitter account</li>
                        <li data-lang="faucet.security.rateLimit">• Rate Limit: 10 requests per hour</li>
                        <li data-lang="faucet.security.recaptcha">• reCAPTCHA: Must pass Google reCAPTCHA v2 verification</li>
                        <li data-lang="faucet.security.twitterBinding">• Twitter Binding: Must bind Twitter account to claim</li>
                    </ul>
                    <!-- <ul class="text-sm text-stone-700 space-y-1">
                        <li data-lang="faucet.claim.instruction1">• Each wallet address can only claim once every 24 hours</li>
                        <li data-lang="faucet.claim.instruction2">• Claim 0.1 PHRS testnet tokens each time</li>
                        <li data-lang="faucet.claim.instruction3">• Complete signature login and reCAPTCHA verification required</li>
                        <li data-lang="faucet.claim.instruction4">• Recommend binding Twitter account for better service</li>
                        <li data-lang="faucet.claim.instruction5">• Use wallet connection</li>
                        <li data-lang="faucet.claim.instruction6">• Ensure on Pharos Testnet network</li>
                    </ul> -->
                </div>

                <div id="faucet-recaptcha-container" class="mb-4" style="display: none;">
                    <div class="g-recaptcha" style="display: flex; justify-content: space-around;" data-sitekey="6LchwbIrAAAAAEkI8iLHCgWV13kSiQhj9Wov_1he" data-callback="onFaucetRecaptchaSuccess" data-expired-callback="onFaucetRecaptchaExpired"></div>
                </div>

                <div class="flex justify-center gap-2 mb-4 mt-4">
                    <button id="claimTokens" disabled class="px-12 py-4 rounded-ui text-wood-900 font-extrabold text-md w-full disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200" style="background-color: rgb(184 135 90 / var(--tw-bg-opacity, 1));">
                        <span id="claimButtonText">Claim Now!</span>
                        <span id="claimCountdown" class="hidden"></span>
                    </button>
                </div>
            </div>



        </div>
    </section>

    <footer class="bg-white border-t border-wood-200 mt-12">
        <div class="max-w-6xl mx-auto px-4 py-8 flex flex-col items-center gap-4">
            <div class="flex items-center gap-4">
                <a href="https://x.com/GooseBoxGame" target="_blank" rel="noopener noreferrer"
                   class="inline-flex items-center gap-2 px-4 py-2 rounded-[14px] bg-wood-100 border border-wood-200 text-wood-900 shadow-ui hover:bg-wood-200">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 1227" class="w-5 h-5" fill="currentColor">
                        <path d="M714 519l452-519H1002L652 408 357 0H0l469 638L0 1227h198l375-431 311 431h357L714 519zM593 742l-86-118-308 353h180l214-235zm263 170L742 694l-84 92 220 305h170L856 912zM326 142l610 910h-171L261 142h65z"/>
                    </svg>
                    <span>X</span>
                </a>
                <a href="https://t.me/GooseBoxTG" target="_blank" rel="noopener noreferrer"
                   class="inline-flex items-center gap-2 px-4 py-2 rounded-[14px] bg-wood-100 border border-wood-200 text-wood-900 shadow-ui hover:bg-wood-200">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240" class="w-5 h-5" fill="currentColor">
                        <path d="M120 0a120 120 0 10120 120A120 120 0 00120 0zm58.1 75.5L147 179.8c-2 9.2-7.5 11.4-15.2 7.1l-42-31  -20.2 19.4c-2.2 2.2-4 4-8.2 4l2.9-41.2 74.9-67.5c3.3-2.9-.7-4.6-5.1-1.7l-92.5 58.2-39.8-12.4c-8.6-2.7-8.8-8.6 1.8-12.7l155.8-60.1c7.2-2.6 13.5 1.7 11.1 12.1z"/>
                    </svg>
                    <span>Telegram</span>
                </a>
            </div>
            <p class="text-stone-400">© 2025 Goosebox</p>
        </div>
    </footer>

    <script src="./js/languages.js?v=2025.01.27.1"></script>
    
    
    
    <script>

        let walletAddress = null;
        let authToken = null;
        let currentNonce = null;
        let currentMessage = null;
        let faucetRecaptchaToken = null;
        let countdownTimer = null;
        let currentCooldownTime = 0;
        let currentLang = defaultLanguage;
        let isCheckingTwitterStatus = false;
        let isCheckingFaucetStatus = false;
        let faucetStatusPromise = null;
        let lastFaucetCheckTime = 0;
        const FAUCET_CHECK_COOLDOWN = 2000; // 2秒冷却期
        
        // 防止重复认证的状态管理
        let isAuthenticating = false;
        let lastAuthTime = 0;
        const AUTH_COOLDOWN = 5000; // 5秒认证冷却期
        let authPromise = null;

        const currentStatusStates = {
            walletStatus: { type: null, messageKey: null, params: null, isCustom: false },
            faucetStatus: { type: null, messageKey: null, params: null, isCustom: false }
        };

        // 存储当前 Twitter 连接状态信息
        let currentTwitterInfo = null;

        const API_BASE = 'https://api.gbox.game/api/faucet-auth';

        function initLanguage() {
            const savedLang = localStorage.getItem('goosebox_lang');
            const config = getLanguageConfig();
            if (savedLang && config[savedLang]) {
                currentLang = savedLang;
            }
            updateLanguage(currentLang);
            renderLanguageSelector();
        }

        function updateLanguage(lang) {
            const langData = getLanguageData(lang);
            
            document.title = langData.faucet?.title ? `${langData.faucet.title} - Goosebox` : (lang === 'zh' ? '加入Goosebox！ - Goosebox' : 'Join Goosebox! - Goosebox');
            
            const subtitleElement = document.getElementById('subtitle');
            if (subtitleElement) {
                subtitleElement.textContent = langData.faucet?.subtitle || langData.subtitle;
            }
            
            document.getElementById('heroTitle').textContent = langData.faucet?.heroTitle || langData.hero.title;
            document.getElementById('heroDescription').textContent = langData.faucet?.heroDescription || langData.hero.description;

            const navElements = document.querySelectorAll('[data-lang]');
            navElements.forEach(element => {
                const langKey = element.getAttribute('data-lang');
                const keys = langKey.split('.');
                let value = langData;
                for (const key of keys) {
                    if (value && value[key]) {
                        value = value[key];
                    } else {
                        value = '';
                        break;
                    }
                }
                if (value) {
                    element.textContent = value;
                }
            });
            
            updateWalletStatusDisplay();
            
            updateAllStatusDisplays();
            
            const flagElement = document.getElementById('currentLangFlag');
            const nameElement = document.getElementById('currentLangName');
            
            if (flagElement && nameElement) {
                const config = getLanguageConfig();
                if (config && config[lang]) {
                    const flagCode = config[lang].flag;
                    const name = config[lang].name;
                    flagElement.className = `fi fi-${flagCode}`;
                    nameElement.textContent = name;
                }
            }
        }

        function updateWalletStatusDisplay() {
            if (walletAddress && authToken) {
                const langData = getLanguageData(currentLang);
                const walletConnectedMsg = langData.faucet?.messages?.walletConnected || '钱包已连接';
                showStatus('walletStatus', `${walletConnectedMsg}: ${formatAddress(walletAddress)}`, 'success');
                
                currentStatusStates.walletStatus = {
                    type: 'success',
                    messageKey: 'faucet.messages.walletConnected',
                    params: { address: walletAddress },
                    isCustom: true
                };
            }
        }

        function updateClaimButtonText() {
            const buttonTextElement = document.getElementById('claimButtonText');
            const claimButton = document.getElementById('claimTokens');
            const recaptchaContainer = document.getElementById('faucet-recaptcha-container');
            
            if (!authToken) {
                buttonTextElement.textContent = 'Connect Wallet';
                if (recaptchaContainer) {
                    recaptchaContainer.style.display = 'none';
                }
                if (claimButton) {
                    claimButton.disabled = false;
                }
            } else if (currentTwitterInfo) {
                buttonTextElement.textContent = 'Claim Now';
                // 只有在Twitter已连接且不在冷却期间才显示reCAPTCHA
                if (recaptchaContainer) {
                    recaptchaContainer.style.display = currentCooldownTime > 0 ? 'none' : 'block';
                }
            } else {
                buttonTextElement.textContent = 'Connect X Account for More';
                if (recaptchaContainer) {
                    recaptchaContainer.style.display = 'none';
                }
                if (claimButton) {
                    claimButton.disabled = false;
                }
            }
        }

        function updateAllStatusDisplays() {
            Object.keys(currentStatusStates).forEach(elementId => {
                const state = currentStatusStates[elementId];
                if (state.messageKey && !state.isCustom) {
                    showStatusI18n(elementId, state.messageKey, state.type, state.params);
                } else if (state.isCustom && elementId === 'walletStatus' && walletAddress && authToken) {
                    updateWalletStatusDisplay();
                }
            });
            // 更新按钮文本和状态
            updateClaimButtonText();
            checkClaimButtonState();
        }

        // 更新钱包按钮可见性
        function updateWalletButtonVisibility(isConnected) {
            const connectBtn = document.getElementById('open-connect-modal');
            const connectMobileBtn = document.getElementById('open-connect-modal-mobile');
            const disconnectBtn = document.getElementById('disconnect');
            const disconnectMobileBtn = document.getElementById('disconnect-mobile');
            
            if (isConnected) {
                // 钱包已连接：隐藏连接按钮，显示断开按钮
                if (connectBtn) connectBtn.style.display = 'none';
                if (connectMobileBtn) connectMobileBtn.style.display = 'none';
                if (disconnectBtn) disconnectBtn.style.display = 'inline-block';
                if (disconnectMobileBtn) disconnectMobileBtn.style.display = 'inline-block';
            } else {
                // 钱包未连接：显示连接按钮，隐藏断开按钮
                if (connectBtn) connectBtn.style.display = 'inline-block';
                if (connectMobileBtn) connectMobileBtn.style.display = 'inline-block';
                if (disconnectBtn) disconnectBtn.style.display = 'none';
                if (disconnectMobileBtn) disconnectMobileBtn.style.display = 'none';
            }
            

        }

        
        function renderLanguageSelector() {
            const container = document.getElementById('languageOptions');
            const config = getLanguageConfig();
            container.innerHTML = Object.entries(config).map(([code, lang]) => `
                <button class="w-full text-left px-4 py-2 hover:bg-wood-50 text-wood-900 transition-colors duration-150 ${code === currentLang ? 'bg-wood-100 text-wood-900 font-medium' : 'hover:text-wood-700'} flex items-center gap-3 rounded-md" 
                        onclick="switchLanguage('${code}')">
                    <span class="fi fi-${lang.flag} text-lg flex-shrink-0"></span>
                    <span class="truncate">${lang.name}</span>
                    ${code === currentLang ? '<span class="ml-auto text-wood-700 text-sm">✓</span>' : ''}
                </button>
            `).join('');
        }

        
        function switchLanguage(lang) {
            const config = getLanguageConfig();
            if (config[lang]) {
                currentLang = lang;
                localStorage.setItem('goosebox_lang', lang);
                updateLanguage(lang);
                renderLanguageSelector();
                
                const button = document.getElementById('currentLang');
                button.classList.add('scale-95');
                setTimeout(() => button.classList.remove('scale-95'), 150);
            }
        }

        
        function getLanguageConfig() {
            if (typeof languageConfig !== 'undefined') {
                return languageConfig;
            }
            
            return {
                zh: { name: '中文', flag: 'cn' },
                en: { name: 'English', flag: 'us' }
            };
        }

        
        function onFaucetRecaptchaSuccess(token) {
            faucetRecaptchaToken = token;

            checkClaimButtonState();
        }

        function onFaucetRecaptchaExpired() {
            faucetRecaptchaToken = null;

            document.getElementById('claimTokens').disabled = true;
        }

        
        function checkClaimButtonState() {
            const hasAuth = authToken;
            const hasRecaptcha = faucetRecaptchaToken;
            const noCooldown = currentCooldownTime <= 0;
            const hasTwitter = currentTwitterInfo;

            if (noCooldown) {
                if (!hasAuth) {
                    // 没有认证，按钮应该可用让用户连接钱包
                    document.getElementById('claimTokens').disabled = false;
                } else if (hasTwitter) {
                    // 已认证且Twitter已连接，需要reCAPTCHA才能领取代币
                    document.getElementById('claimTokens').disabled = !hasRecaptcha;
                } else {
                    // 已认证但Twitter未连接，按钮应该可用让用户连接Twitter
                    document.getElementById('claimTokens').disabled = false;
                }
            } else {
                // 冷却期内，禁用按钮
                document.getElementById('claimTokens').disabled = true;
            }
        }


        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            if (!element) {

                return;
            }
            
            const statusClass = {
                'info': 'p-4 border rounded-lg bg-blue-50 border-blue-200 text-blue-800 mb-2',
                'success': 'p-4 border rounded-lg bg-green-50 border-green-200 text-green-800 mb-2',
                'error': 'p-4 border rounded-lg bg-red-50 border-red-200 text-red-800 mb-2',
                'warning': 'p-4 border rounded-lg bg-yellow-50 border-yellow-200 text-yellow-800 mb-2'
            };
            
            element.innerHTML = `<div class="${statusClass[type]}">${message}</div>`;
            
           
            if (currentStatusStates[elementId] && !showStatus.fromI18n) {
                currentStatusStates[elementId] = {
                    type: type,
                    messageKey: null,
                    params: null,
                    isCustom: true
                };
            }
        }

     
        function showStatusI18n(elementId, messageKey, type = 'info', params = {}) {
            const langData = getLanguageData(currentLang);
            const keys = messageKey.split('.');
            let message = langData;
            for (const key of keys) {
                if (message && message[key]) {
                    message = message[key];
                } else {
                    message = messageKey;
                    break;
                }
            }
            
            if (typeof message === 'string') {
                Object.keys(params).forEach(key => {
                    message = message.replace(`{${key}}`, params[key]);
                });
            }
            
            if (currentStatusStates[elementId]) {
                currentStatusStates[elementId] = {
                    type: type,
                    messageKey: messageKey,
                    params: params,
                    isCustom: false
                };
            }
            
            showStatus.fromI18n = true;
            showStatus(elementId, message, type);
            showStatus.fromI18n = false;
        }

        
        function getI18nMessage(messageKey, fallback = '') {
            const langData = getLanguageData(currentLang);
            const keys = messageKey.split('.');
            let message = langData;
            for (const key of keys) {
                if (message && message[key]) {
                    message = message[key];
                } else {
                    return fallback || messageKey;
                }
            }
            return message;
        }

        function formatAddress(address) {
            return `<span class="font-mono bg-gray-100 px-2 py-1 rounded text-sm">${address.slice(0, 6)}...${address.slice(-4)}</span>`;
        }




        function formatCountdown(seconds) {
            if (seconds <= 0) return '';

            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;

            const langData = getLanguageData(currentLang);
            const hoursText = langData.faucet?.messages?.hours || 'hours';
            const minutesText = langData.faucet?.messages?.minutes || 'minutes';
            const secondsText = langData.faucet?.messages?.seconds || 'seconds';

            if (hours > 0) {
                return `${hours}${hoursText}${minutes}${minutesText}`;
            } else if (minutes > 0) {
                return `${minutes}${minutesText}${secs}${secondsText}`;
            } else {
                return `${secs}${secondsText}`;
            }
        }


        function startCountdown(remainingSeconds) {

            if (countdownTimer) {
                clearInterval(countdownTimer);
            }

            currentCooldownTime = remainingSeconds;

            if (remainingSeconds <= 0) {

                enableClaimButton();
                return;
            }


            disableClaimButton();
            updateCountdownDisplay();

            countdownTimer = setInterval(() => {
                currentCooldownTime--;

                if (currentCooldownTime <= 0) {
                    clearInterval(countdownTimer);
                    enableClaimButton();
                } else {
                    updateCountdownDisplay();
                }
            }, 1000);
        }


        function updateCountdownDisplay() {
            const countdownElement = document.getElementById('claimCountdown');
            const buttonTextElement = document.getElementById('claimButtonText');
            const recaptchaContainer = document.getElementById('faucet-recaptcha-container');

            if (currentCooldownTime > 0) {
                buttonTextElement.style.display = 'none';
                countdownElement.style.display = 'inline';
                
                // 冷却期间隐藏reCAPTCHA
                if (recaptchaContainer) {
                    recaptchaContainer.style.display = 'none';
                }
                
                const langData = getLanguageData(currentLang);
                const cooldownText = langData.faucet?.messages?.cooldown || 'Cooling down';
                countdownElement.textContent = `${cooldownText} (${formatCountdown(currentCooldownTime)})`;
            } else {
                buttonTextElement.style.display = 'inline';
                countdownElement.style.display = 'none';
                
                // 冷却结束后，根据当前状态重新显示reCAPTCHA
                updateClaimButtonText();
            }
        }


        function enableClaimButton() {
            const button = document.getElementById('claimTokens');
            const buttonTextElement = document.getElementById('claimButtonText');
            const countdownElement = document.getElementById('claimCountdown');

            button.disabled = false;
            buttonTextElement.style.display = 'inline';
            countdownElement.style.display = 'none';

            // 更新按钮文本
            updateClaimButtonText();

            checkClaimButtonState();
        }


        function disableClaimButton() {
            const button = document.getElementById('claimTokens');
            button.disabled = true;
        }

        // Twitter连接功能已整合到主按钮中



        document.getElementById('claimTokens')?.addEventListener('click', async () => {
            try {
                // 如果没有认证，点击按钮应该连接钱包
                if (!authToken) {
                    // 触发钱包连接
                    const connectBtn = document.getElementById('open-connect-modal');
                    if (connectBtn) {
                        connectBtn.click();
                    }
                    return;
                }
                
                // 如果Twitter未连接，点击按钮应该连接Twitter
                if (!currentTwitterInfo) {
                    // 直接执行Twitter连接逻辑
                    try {
                        const currentToken = localStorage.getItem('faucetAuthToken') || authToken;
                        if (!currentToken) {
                            showStatusI18n('faucetStatus', 'faucet.messages.authRequired', 'error');
                            return;
                        }

                        showStatusI18n('faucetStatus', 'faucet.messages.preparingTwitterConnection', 'info');

                        const response = await fetch(`${API_BASE}/twitter`, {
                            method: 'GET',
                            credentials: 'include',
                            headers: { 'Authorization': `Bearer ${currentToken}` }
                        });

                        const data = await response.json();

                        const needsReauth = response.status === 401 || 
                            data.error === 'Authentication required' || 
                            data.message?.includes('Please login with your wallet first');

                        if (needsReauth) {
                            localStorage.removeItem('faucetAuthToken');
                            localStorage.removeItem('faucetUser');
                            authToken = null;
                            
                            if (!window.appKit?.getIsConnectedState()) {
                                throw new Error('请先连接钱包');
                            }

                            try {
                                showStatusI18n('faucetStatus', 'faucet.messages.reAuthenticating', 'info');
                                await autoStartAuthFlow();
                                
                                const newToken = localStorage.getItem('faucetAuthToken') || authToken;
                                if (newToken) {
                                    window.location.href = `${API_BASE}/twitter`;
                                } else {
                                    throw new Error('重新登录失败');
                                }
                            } catch (authError) {
                                if (authError.message?.includes('User rejected')) {
                                    showStatusI18n('faucetStatus', 'faucet.messages.userCancelledSignature', 'warning');
                                    return;
                                }
                                throw authError;
                            }
                        } else {
                            throw new Error(data.message || data.error || '未知错误');
                        }
                    } catch (error) {
                        window.location.href = `${API_BASE}/twitter`;
                    }
                    return;
                }

                if (!faucetRecaptchaToken) {
                    showStatusI18n('faucetStatus', 'faucet.errors.recaptchaRequired', 'error');
                return;
            }

                if (!window.appKit || !window.appKit.getIsConnectedState()) {
                    showStatusI18n('faucetStatus', 'faucet.errors.walletRequired', 'error');
                return;
            }

                showStatusI18n('faucetStatus', 'faucet.messages.submittingClaim', 'info');

                const token = localStorage.getItem('faucetAuthToken') || authToken;
                if (!token) {
                    throw new Error('请先登录');
                }

                const response = await fetch(`${API_BASE}/claim/signature`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        recaptchaToken: faucetRecaptchaToken
                    })
                });

                const data = await response.json();



                if (!data.success) {
                    let errorDetails = {
                        message: data.message || data.error,
                        fullResponse: data
                    };

                    const error = new Error(data.message || data.error);
                    error.details = errorDetails;
                    throw error;
                }

                const { distributionId, amount, status, twitter, rateLimit, note } = data.data;

                const langData = getLanguageData(currentLang);
                let successMessage = data.message || langData.faucet?.messages?.claimSuccess || 'Claim request submitted successfully';
                let successDetails = '';
                
                showStatus('faucetStatus', 
                    `✅ ${successMessage}`, 
                    'success'
                );

                startCountdown(86400);

                if (typeof grecaptcha !== 'undefined') {
                    grecaptcha.reset();
                    faucetRecaptchaToken = null;
                    checkClaimButtonState();
                }

            } catch (error) {


                let errorMessage = `申请发币失败: ${error.message}`;
                let errorDetails = '';
                if (error.message.includes('User cooldown not met')) {
                    errorMessage = '用户冷却期未满，24小时内只能申请一次';
                    if (error.details && error.details.fullResponse && error.details.fullResponse.data) {
                        const { remainingTime, lastClaimTime } = error.details.fullResponse.data;
                        errorDetails = `<br><br><div class="bg-yellow-50 p-3 rounded border border-yellow-200">` +
                                     `<strong>冷却期信息:</strong><br>` +
                                     `剩余等待时间: ${Math.ceil(remainingTime / 60)} 分钟<br>` +
                                     `上次申请时间: ${new Date(lastClaimTime * 1000).toLocaleString()}<br>` +
                                           `</div>`;
                            }
                } else if (error.message.includes('IP cooldown not met')) {
                    errorMessage = 'IP地址冷却期未满，24小时内只能申请一次';
                    if (error.details && error.details.fullResponse && error.details.fullResponse.data) {
                        const { remainingTime, lastClaimTime, ipAddress } = error.details.fullResponse.data;
                        errorDetails = `<br><br><div class="bg-yellow-50 p-3 rounded border border-yellow-200">` +
                                     `<strong>IP冷却期信息:</strong><br>` +
                                     `IP地址: ${ipAddress}<br>` +
                                     `剩余等待时间: ${Math.ceil(remainingTime / 60)} 分钟<br>` +
                                     `上次申请时间: ${new Date(lastClaimTime * 1000).toLocaleString()}<br>` +
                                   `</div>`;
                    }
                } else if (error.message.includes('Twitter ID cooldown not met')) {
                    errorMessage = 'Twitter账户冷却期未满，24小时内只能申请一次';
                    if (error.details && error.details.fullResponse && error.details.fullResponse.data) {
                        const { remainingTime, lastClaimTime, twitterId, twitterUsername } = error.details.fullResponse.data;
                        errorDetails = `<br><br><div class="bg-yellow-50 p-3 rounded border border-yellow-200">` +
                                     `<strong>Twitter冷却期信息:</strong><br>` +
                                     `Twitter: @${twitterUsername} (ID: ${twitterId})<br>` +
                                     `剩余等待时间: ${Math.ceil(remainingTime / 60)} 分钟<br>` +
                                     `上次申请时间: ${new Date(lastClaimTime * 1000).toLocaleString()}<br>` +
                                     `</div>`;
                    }
                } else if (error.message.includes('Rate limit exceeded')) {
                    errorMessage = '请求频率过高，请稍后再试';
                    if (error.details && error.details.fullResponse && error.details.fullResponse.data) {
                        const { resetTime, retryAfter } = error.details.fullResponse.data;
                        errorDetails = `<br><br><div class="bg-red-50 p-3 rounded border border-red-200">` +
                                     `<strong>速率限制信息:</strong><br>` +
                                     `限制重置时间: ${new Date(resetTime * 1000).toLocaleString()}<br>` +
                                     `重试等待时间: ${Math.ceil(retryAfter / 60)} 分钟<br>` +
                                     `</div>`;
                    }
                } else if (error.message.includes('Twitter not bound')) {
                    errorMessage = '请先绑定Twitter账户';
                    errorDetails = `<br><br><div class="bg-blue-50 p-3 rounded border border-blue-200">` +
                                 `<strong>解决方案:</strong> 请先完成Twitter账户绑定，然后再次尝试申请` +
                                 `</div>`;
                } else if (error.message.includes('reCAPTCHA')) {
                    errorMessage = 'reCAPTCHA验证失败，请重新验证';
                    errorDetails = `<br><br><div class="bg-blue-50 p-3 rounded border border-blue-200">` +
                                 `<strong>解决方案:</strong> 请重新完成reCAPTCHA验证` +
                                 `</div>`;
                }

                if (error.details && error.details.fullResponse) {
                    errorDetails += `<br><br><strong>调试信息:</strong><br>` +
                                   `<div class="bg-gray-100 p-2 rounded text-xs" style="max-height: 200px; overflow-y: auto;">` +
                                   `${JSON.stringify(error.details.fullResponse, null, 2)}` +
                                   `</div>`;
                }

                showStatus('faucetStatus', errorMessage + errorDetails, 'error');

                if (typeof grecaptcha !== 'undefined') {
                    grecaptcha.reset();
                    faucetRecaptchaToken = null;
                    checkClaimButtonState();
                }
            }
        });

        async function handleTwitterCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const state = urlParams.get('state');
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            const message = urlParams.get('message');



            if (error) {
                showTwitterSection();
                
                const twitterAuthFailedMsg = getI18nMessage('faucet.messages.twitterAuthFailed', 'Twitter 授权失败');
                showStatus('faucetStatus', `${twitterAuthFailedMsg}: ${decodeURIComponent(message || error)}`, 'error');
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }

            if (state && code) {

                
                const callbackStatus = document.getElementById('twitterCallbackStatus');
                const callbackDetails = document.getElementById('twitterCallbackDetails');
                if (callbackStatus && callbackDetails) {
                    callbackStatus.style.display = 'block';
                    callbackDetails.textContent = '检测到授权回调，正在处理...';
                }
                
                showStatusI18n('faucetStatus', 'faucet.messages.bindingTwitterAccount', 'info');

                    // 在调用绑定 API 前，按钮状态由其他逻辑控制

                try {
                    const currentToken = localStorage.getItem('faucetAuthToken') || authToken;


                    if (!currentToken) {
                        const errorMsg = '未找到认证 Token，请先完成钱包连接和签名认证';


                        if (callbackDetails) {
                            callbackDetails.textContent = '认证失败：需要先完成钱包连接和签名';
                        }
                        
                        showStatusI18n('faucetStatus', 'faucet.messages.authRequired', 'warning');
                        return;
                    }



                    const response = await fetch(`${API_BASE}/twitter/bind`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${currentToken}`
                        },
                        credentials: 'include',
                        body: JSON.stringify({ state, code })
                    });


                    const data = await response.json();


                    if (data.success) {
                        const twitter = data.data.twitter;
                        
                        if (callbackDetails) {
                            callbackDetails.textContent = '绑定成功！';
                        }
                        
                        // 存储 Twitter 信息以便语言切换时更新
                        currentTwitterInfo = { username: twitter.username };
                        
                        showFaucetClaimSection();
                        
                        // 更新按钮文本
                        updateClaimButtonText();
                        
                        try {
                            await autoCheckFaucetStatus();
                        } catch (checkError) {

                        }
                        
                        if (callbackStatus) {
                            callbackStatus.style.display = 'none';
                        }
                    } else {
                        throw new Error(data.message || data.error);
                    }

                } catch (error) {
                    // 清除 Twitter 信息
                    currentTwitterInfo = null;
                    
                    // 更新按钮文本
                    updateClaimButtonText();
                    
                    if (callbackDetails) {
                        callbackDetails.textContent = `绑定失败：${error.message}`;
                    }
                    
                    // 确保错误信息不为空
                    const errorMessage = error.message || error.toString() || 'Unknown error';
                    
                    // 存储错误信息以便语言切换时更新
                    currentStatusStates.faucetStatus = {
                        type: 'error',
                        messageKey: 'faucet.messages.twitterBindingFailed',
                        params: { error: errorMessage },
                        isCustom: false
                    };
                    
                    showStatusI18n('faucetStatus', 'faucet.messages.twitterBindingFailed', 'error', { error: errorMessage });
                }

                
                window.history.replaceState({}, document.title, window.location.pathname);
            } else {

            }
        }

        async function checkLocalAuth() {
            const savedToken = localStorage.getItem('faucetAuthToken');
            const savedUser = localStorage.getItem('faucetUser');

            if (savedToken && savedUser) {
                try {
                    authToken = savedToken;
                    const user = JSON.parse(savedUser);

                    if (isTokenExpired(savedToken)) {

                        localStorage.removeItem('faucetAuthToken');
                        localStorage.removeItem('faucetUser');
                        return false;
                    }

                    walletAddress = user.walletAddress;


                    const walletConnectedMsg = getLanguageData(currentLang).faucet?.messages?.walletConnected || '钱包已连接';
                    showStatus('walletStatus', `${walletConnectedMsg}: ${formatAddress(user.walletAddress)}`, 'success');

                    return true;
                } catch (error) {

                    localStorage.removeItem('faucetAuthToken');
                    localStorage.removeItem('faucetUser');
                    return false;
                }
            }
            return false;
        }

        function clearLocalAuth() {
            localStorage.removeItem('faucetAuthToken');
            localStorage.removeItem('faucetUser');
            authToken = null;
            
            // 重置认证相关状态
            authPromise = null;
            lastAuthTime = 0;
            currentNonce = null;
            currentMessage = null;
            
            // 清除初始化标记
            window.initialAuthProcessed = false;
            window.needsReauth = false;
            window.localAuthChecked = true; // 保持true，避免重复检查
            
            document.getElementById('claimTokens').disabled = true;
            
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
            currentCooldownTime = 0;
            
            const buttonTextElement = document.getElementById('claimButtonText');
            const countdownElement = document.getElementById('claimCountdown');
            if (buttonTextElement) buttonTextElement.style.display = 'inline';
            if (countdownElement) countdownElement.style.display = 'none';
            

        }

        function isTokenExpired(token) {
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const currentTime = Math.floor(Date.now() / 1000);

                if (payload.exp && payload.exp < currentTime) {
                    return true;
                }
                
                return false;
            } catch (error) {

                return true;
            }
        }
        
        function autoClearAuth() {
            try {
                clearLocalAuth();
                
                showStatusI18n('walletStatus', 'faucet.messages.walletDisconnected', 'info');
                            // 清空其他状态而不是显示空框
            document.getElementById('faucetStatus').innerHTML = '';
            
            // 清除 Twitter 信息
            currentTwitterInfo = null;
            currentStatusStates.faucetStatus = { type: null, messageKey: null, params: null, isCustom: false };
                
                showFaucetClaimSection();
                
                // 更新按钮文本
                updateClaimButtonText();
                
                currentNonce = null;
                currentMessage = null;
                faucetRecaptchaToken = null;
                

                
            } catch (error) {

            }
        }

        async function autoStartAuthFlow() {
            const currentTime = Date.now();
            
            // 检查冷却期
            if (currentTime - lastAuthTime < AUTH_COOLDOWN) {

                return;
            }
            
            // 如果正在认证，返回现有的 Promise
            if (authPromise) {

                return authPromise;
            }
            
            // 检查是否已有有效的认证
            if (authToken && walletAddress) {
                try {

                    const response = await fetch(`${API_BASE}/me`, {
                        headers: { 'Authorization': `Bearer ${authToken}` },
                        credentials: 'include'
                    });
                    const data = await response.json();
                    
                    if (data.success && data.data && data.data.user && 
                        data.data.user.walletAddress.toLowerCase() === walletAddress.toLowerCase()) {

                        
                        // 更新UI状态
                        const walletConnectedMsg = getLanguageData(currentLang).faucet?.messages?.walletConnected || '钱包已连接';
                        showStatus('walletStatus', `${walletConnectedMsg}: ${formatAddress(walletAddress)}`, 'success');
                        updateWalletButtonVisibility(true);
                        checkClaimButtonState();
                        
                        // 检查状态
                        try {
                            await autoCheckFaucetStatus();
                        } catch (error) {

                        }
                        
                        return;
                    } else {

                        clearLocalAuth();
                    }
                } catch (verifyError) {

                    clearLocalAuth();
                }
            }
            
            // 如果没有Token或Token无效，才开始新的认证流程
            if (!authToken) {

            } else {

            }
            
            // 更新状态和时间
            lastAuthTime = currentTime;
            
            // 创建认证Promise
            authPromise = (async () => {
                try {

                    
                    const response = await fetch(`${API_BASE}/nonce`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ walletAddress })
                    });

                    const data = await response.json();

                    if (!data.success) {
                        throw new Error(data.message || data.error);
                    }

                    currentNonce = data.data.nonce;
                    currentMessage = data.data.message;
                    
                    // 等待钱包提供者可用，最多等待5秒
                    let provider = null;
                    let attempts = 0;
                    const maxAttempts = 50; // 5秒，每次等待100ms
                    
                    while (!provider && attempts < maxAttempts) {
                        provider = window.getProvider();
                    if (!provider) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                            attempts++;

                        }
                    }
                    
                    if (!provider) {
                        throw new Error('无法获取钱包提供者，请确保钱包已连接并重试');
                    }
                    
                    const signature = await provider.request({
                        method: 'personal_sign',
                        params: [currentMessage, walletAddress]
                    });

                    const loginResponse = await fetch(`${API_BASE}/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                            walletAddress,
                            signature,
                            message: currentMessage
                        })
                    });

                    const loginData = await loginResponse.json();

                    if (!loginData.success) {
                        throw new Error(loginData.message || loginData.error);
                    }

                    authToken = loginData.data.token;
                    const user = loginData.data.user;
                    
                    localStorage.setItem('faucetAuthToken', authToken);
                    localStorage.setItem('faucetUser', JSON.stringify(user));


                    showStatus('walletStatus', `Wallet Connected: ${formatAddress(user.walletAddress)}`, 'success');
                    checkClaimButtonState();
                    
                    try {
                        await autoCheckFaucetStatus();
                    } catch (error) {

                    }

                } catch (error) {

                    
                    if (error.message.includes('User rejected')) {
                        showStatusI18n('walletStatus', 'faucet.messages.userCancelledTransaction', 'warning');
                    } else if (error.message.includes('Please wait before requesting')) {
                        showStatusI18n('walletStatus', 'faucet.messages.authRateLimit', 'warning');
                    } else {
                        showStatusI18n('walletStatus', 'faucet.messages.authFailed', 'error');
                    }
                    throw error;
                } finally {
                    // 延迟清除 Promise 引用
                    setTimeout(() => {
                        authPromise = null;
                    }, 1000);
                }
            })();
            
            return authPromise;
        }

        
        async function autoCheckTwitterStatus() {

            await autoCheckFaucetStatus();
        }

        function hideTwitterSection() {
            // Twitter连接部分已移除，这个函数现在不需要做任何事情
        }

        function showTwitterSection() {
            // Twitter连接部分已移除，这个函数现在不需要做任何事情
        }

        function hideFaucetClaimSection() {
            const faucetSection = document.getElementById('faucetClaimSection');
            if (faucetSection) {
                faucetSection.style.display = 'none';
                // 同时清空 faucetStatus 内容，避免显示空状态框
                const faucetStatus = document.getElementById('faucetStatus');
                if (faucetStatus) {
                    faucetStatus.innerHTML = '';
                }
            }
        }

        function showFaucetClaimSection() {
            const faucetSection = document.getElementById('faucetClaimSection');
            if (faucetSection) {
                faucetSection.style.display = 'block';
            }
        }
        
        async function autoCheckFaucetStatus() {
            const currentTime = Date.now();
            
            // 检查冷却期
            if (currentTime - lastFaucetCheckTime < FAUCET_CHECK_COOLDOWN) {

                return;
            }
            
            // 如果已经有正在进行的请求，返回同一个 Promise
            if (faucetStatusPromise) {

                return faucetStatusPromise;
            }
            
            // 更新最后检查时间
            lastFaucetCheckTime = currentTime;
            
            // 创建新的检查Promise
            faucetStatusPromise = (async () => {
                try {
                    const token = localStorage.getItem('faucetAuthToken') || authToken;
                    if (!token) {
                        return; 
                    }



                    const response = await fetch(`${API_BASE}/claim/status`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        credentials: 'include'
                    });

                    const data = await response.json();

                    if (!data.success) {
                        return;
                    }

                    const { user, ip, twitter } = data.data;

                    // 处理 Twitter 状态信息
                    if (twitter && twitter.isBound) {
                        showFaucetClaimSection();
                        
                        // 存储 Twitter 信息以便语言切换时更新
                        currentTwitterInfo = { username: twitter.username };
                    } else {
                        currentTwitterInfo = null; // 清除 Twitter 信息
                        showFaucetClaimSection();
                    }
                    
                    // 更新按钮文本
                    updateClaimButtonText();

                    // 处理冷却时间
                    let maxCooldownTime = 0;
                    if (user.remainingTime && user.remainingTime > 0) {
                        maxCooldownTime = Math.max(maxCooldownTime, user.remainingTime);
                    }
                    if (ip.remainingTime && ip.remainingTime > 0) {
                        maxCooldownTime = Math.max(maxCooldownTime, ip.remainingTime);
                    }
                    if (twitter.remainingTime && twitter.remainingTime > 0) {
                        maxCooldownTime = Math.max(maxCooldownTime, twitter.remainingTime);
                    }

                    if (maxCooldownTime > 0) {
                        startCountdown(maxCooldownTime);
                    }

                } catch (error) {

                } finally {
                    // 延迟清除 Promise 引用，避免紧密的重复调用
                    setTimeout(() => {
                        faucetStatusPromise = null;
                    }, 500); // 500ms 后清除，给并发调用留缓冲时间
                }
            })();
            
            return faucetStatusPromise;
        }

     
        async function onWalletConnected(address) {

            
            // 如果本地认证还没检查完成，等待一下
            if (!window.localAuthChecked) {

                await new Promise(resolve => {
                    const checkAuth = () => {
                        if (window.localAuthChecked) {

                            resolve();
                        } else {
                            setTimeout(checkAuth, 100);
                        }
                    };
                    checkAuth();
                });
            }
            
            // 如果页面初始化时已经处理过认证，且地址匹配，跳过
            if (window.initialAuthProcessed && walletAddress === address && authToken) {

                updateWalletButtonVisibility(true);
                checkClaimButtonState();
                return;
            }
            
            // 防止重复调用 - 如果钱包地址相同且有有效认证，跳过
            if (walletAddress === address && authToken) {

                // 仍然需要更新按钮状态
                updateWalletButtonVisibility(true);
                checkClaimButtonState();
                return;
            }
            
            // 如果在初始化期间且本地有认证数据，延迟处理避免冲突
            if (!window.appKitInitialized && authToken) {

                setTimeout(() => {
                    if (walletAddress === address && authToken) {

                        updateWalletButtonVisibility(true);
                        checkClaimButtonState();
                    }
                }, 1000);
                return;
            }
            
            const isAccountSwitch = walletAddress && walletAddress.toLowerCase() !== address.toLowerCase();
            
            if (isAccountSwitch) {

                showStatus('walletStatus', 
                    `🔄 检测到账户切换<br><br>` +
                    `从: ${formatAddress(walletAddress)}<br>` +
                    `到: ${formatAddress(address)}<br><br>` +
                    `正在清除旧账户认证状态并重新认证...`, 
                    'info'
                );
            
                clearLocalAuth();
                
                // 重置认证状态
                authPromise = null;
                lastAuthTime = 0;
                
                showFaucetClaimSection();
                
                // 更新按钮文本
                updateClaimButtonText();
                
                walletAddress = address;
                const newAccountMsg = getLanguageData(currentLang).faucet?.messages?.newAccountAuthenticating || '🔄 新账户认证中';
                showStatus('walletStatus', `${newAccountMsg}: ${formatAddress(address)}`, 'info');
                checkClaimButtonState();
                
                // 延迟启动认证流程，避免立即触发
                setTimeout(async () => {
                    try {
                        await autoStartAuthFlow();
                    } catch (error) {

                        showStatusI18n('walletStatus', 'faucet.messages.authFailed', 'error');
                    }
                }, 1000);
                return;
            }

            // 如果钱包地址相同且有认证，验证认证是否有效
            if (authToken && walletAddress === address) {

                
                try {
                    // 先检查 token 是否过期
                    if (isTokenExpired(authToken)) {

                        clearLocalAuth();
                    } else {
                        const response = await fetch(`${API_BASE}/me`, {
                            method: 'GET',
                            headers: { 'Authorization': `Bearer ${authToken}` },
                            credentials: 'include'
                        });

                        const data = await response.json();

                        if (data.success && data.data && data.data.user) {
                            const user = data.data.user;

                            
                            if (user.walletAddress.toLowerCase() === address.toLowerCase()) {
                                const walletConnectedMsg = getLanguageData(currentLang).faucet?.messages?.walletConnected || '钱包已连接';
                                showStatus('walletStatus', `${walletConnectedMsg}: ${formatAddress(address)}`, 'success');
                                updateWalletButtonVisibility(true);
                                checkClaimButtonState();
                                
                                try {
                                    await autoCheckFaucetStatus();
                                } catch (error) {

                                }
                                
                                return;
                            } else {

                                clearLocalAuth();
                            }
                        } else {

                            clearLocalAuth();
                        }
                    }
                } catch (verifyError) {

                    clearLocalAuth();
                }
            }
            
            // 更新钱包地址
            walletAddress = address;
            
            // 只有在真正需要认证时才开始认证流程
            if (!authToken || window.needsReauth) {

                
                const walletConnectedMsg = getLanguageData(currentLang).faucet?.messages?.walletConnected || '钱包已连接';
                showStatus('walletStatus', `${walletConnectedMsg}: ${formatAddress(address)}`, 'info');
                
                // 更新按钮可见性
                updateWalletButtonVisibility(true);
                checkClaimButtonState();
                
                // 延迟启动认证流程，避免在AppKit初始化时的多次调用

                setTimeout(async () => {

                    try {
                        await autoStartAuthFlow();
                    } catch (error) {

                        showStatusI18n('walletStatus', 'faucet.messages.authFailed', 'error');
                    }
                }, 500);
                
                // 清除标记
                window.needsReauth = false;
            } else {

                const walletConnectedMsg = getLanguageData(currentLang).faucet?.messages?.walletConnected || '钱包已连接';
                showStatus('walletStatus', `${walletConnectedMsg}: ${formatAddress(address)}`, 'success');
                updateWalletButtonVisibility(true);
                checkClaimButtonState();
                
                // 检查状态
                try {
                    await autoCheckFaucetStatus();
                } catch (error) {

                }
            }
        }

        function onWalletDisconnected() {

            
            // 检查是否是页面初始化期间的状态变化，如果是则不清除认证
            const isInitializing = !window.appKitInitialized;
            
            if (isInitializing) {

                return;
            }
            
            // 如果之前有连接的钱包地址，才是真正的断开连接
            if (walletAddress) {

                walletAddress = null;
                
                // 清除初始化标记
                window.initialAuthProcessed = false;
                window.needsReauth = false;
                window.localAuthChecked = true; // 保持true，避免重复检查
                
                // 更新按钮可见性
                updateWalletButtonVisibility(false);
                
                showStatusI18n('walletStatus', 'faucet.messages.walletDisconnectedAppKit', 'info');
                checkClaimButtonState();
                
                autoClearAuth();
            } else {

                updateWalletButtonVisibility(false);
            }
        }

  
        function checkTwitterCallbackInURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const state = urlParams.get('state');
            const code = urlParams.get('code');
            
            if (state && code) {

                
                const callbackStatus = document.getElementById('twitterCallbackStatus');
                const callbackDetails = document.getElementById('twitterCallbackDetails');
                if (callbackStatus && callbackDetails) {
                    callbackStatus.style.display = 'block';
                    callbackDetails.textContent = '检测到 Twitter 授权回调，正在处理...';
                }
                
                const authSuccessMsg = getI18nMessage('faucet.messages.twitterAuthSuccess', '✅ Twitter 授权成功！');
                const processingBindingMsg = getI18nMessage('faucet.messages.processingBinding', '检测到授权回调参数，正在处理绑定...');
                const callbackInfoMsg = getI18nMessage('faucet.messages.callbackInfo', '回调信息:');
                const bindingNoticeMsg = getI18nMessage('faucet.messages.bindingNotice', '如果绑定失败，请确保已连接钱包并完成签名认证。');
                
                showStatus('faucetStatus', 
                    `<div class="bg-green-50 p-4 rounded border border-green-200">` +
                    `<strong>${authSuccessMsg}</strong><br>` +
                    `${processingBindingMsg}<br><br>` +
                    `<strong>${callbackInfoMsg}</strong><br>` +
                    `State: ${state.substring(0, 20)}...<br>` +
                    `Code: ${code.substring(0, 20)}...<br><br>` +
                    `${bindingNoticeMsg}` +
                    `</div>`, 
                    'success'
                );
                
                return true;
            }
            
            return false;
        }

        function checkAndRedirectToFaucet() {
            const urlParams = new URLSearchParams(window.location.search);
            const state = urlParams.get('state');
            const code = urlParams.get('code');
            
            if ((state && code) && !window.location.pathname.includes('faucet.html')) {

                
                const newUrl = `${window.location.origin}/faucet.html${window.location.search}`;

                window.location.href = newUrl;
                return true;
            }
            
            return false;
        }

        // 等待 AppKit 初始化的函数
        async function waitForAppKitInit() {
            return new Promise((resolve) => {
                const checkAppKit = () => {
                    if (window.appKit && window.getProvider) {

                        resolve();
                    } else {

                        setTimeout(checkAppKit, 100);
                    }
                };
                checkAppKit();
            });
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const dropdown = document.querySelector('.group');
                if (dropdown) {
                    dropdown.classList.remove('group-hover:opacity-100', 'group-hover:visible', 'group-hover:scale-100');
                }
            }
        });

        window.addEventListener('load', async () => {
            if (checkAndRedirectToFaucet()) {
                return; 
            }
            
            // 等待 AppKit 初始化完成
            await waitForAppKitInit();
            
            // 页面刷新后保持之前的连接状态，不强制断开

            
            initLanguage();
            
            // 在AppKit事件处理之前先检查本地认证
            const authRestored = await checkLocalAuth();
            
            // 设置一个标记，表示本地认证检查已完成
            window.localAuthChecked = true;
            
            // 检查当前 AppKit 连接状态
            const isConnected = window.appKit.getIsConnectedState();
            if (isConnected) {
                const accountState = window.appKitStore.accountState;
                if (accountState && accountState.address) {
                    const connectedAddress = accountState.address;
                    
                    // 如果本地有认证且地址匹配，直接使用
                    if (authRestored && walletAddress && walletAddress.toLowerCase() === connectedAddress.toLowerCase()) {

                        walletAddress = connectedAddress;
                        updateWalletButtonVisibility(true);
                        showStatus('walletStatus', `Wallet Connected: ${formatAddress(connectedAddress)}`, 'success');
                        checkClaimButtonState();
                        
                        // 标记页面初始化时已经处理过认证，避免 onWalletConnected 重复处理
                        window.initialAuthProcessed = true;
                        
                        try {
                            await autoCheckFaucetStatus();
                        } catch (error) {
        
                        }
                    } else {

                        walletAddress = connectedAddress;
                        updateWalletButtonVisibility(true);
                        
                        // 如果地址不匹配，清除旧认证
                        if (authRestored && walletAddress && walletAddress.toLowerCase() !== connectedAddress.toLowerCase()) {
                            clearLocalAuth();
                        }
                        
                        // 只有在本地没有认证或认证无效时，才设置需要重新认证的标记
                        if (!authRestored || !authToken) {

                            window.needsReauth = true;
                        }
                    }
                } else {

                    updateWalletButtonVisibility(false);
                }
            } else {

                updateWalletButtonVisibility(false);
                
                if (!authRestored) {
                    showStatusI18n('walletStatus', 'faucet.messages.waitingWalletConnection', 'info');
                    showFaucetClaimSection();
                    // 更新按钮文本和状态
                    updateClaimButtonText();
                    checkClaimButtonState();
                }
            }

            
            const hasCallback = checkTwitterCallbackInURL();
            
            if (hasCallback) {

                handleTwitterCallback();
            } else {

            }
            
            // 标记AppKit初始化完成
            window.appKitInitialized = true;


        });

    
    </script>

</body>
</html>

